<comment>
    <div class="top-bar">
        <div if="{ !hidden }">
            <!-- Comment content -->
            <p if="{ !opts.checkIsEditting() }">
                {text}
            </p>

            <!-- Edit form -->
            <form class="form" if="{ opts.checkIsEditting() }">
                <div class="form-group">
                    <label class="sr-only" for="comment-edit-textarea-{opts.id}">
                        { t('Edit comment') }
                    </label>
                    <textarea id="comment-edit-textarea-{opts.id}"
                              class="form-control"
                              maxlength="500"
                              rows="3">{text}</textarea>
                </div>
                <button type="submit"
                        onclick="{ opts.sendEdit }"
                        class="btn btn-default">
                    { t("Send") }
                    <span if="{ opts.sendEditWaiting }" class="loading"/>
                </button>
            </form>

        </div>
        <div if="{ hidden }">
            <p>{ t('Comment removed.') }</p>
        </div>
        <div>
            <a onclick={ fRoute('pessoa ' + author) }>
                {author}
            </a>
            <button class="btn btn-default comment-reply-button"
                    onclick="{ opts.openReplyArea }">
                { t("reply") }
            </button>

            <!-- Author buttons -->
            <div if="{ opts.checkIsAuthor() && !hidden }">
                <button class="btn btn-danger comment-delete-button"
                        onclick="{ opts.sendDelete }">
                    { t("Delete") }
                    <span if="{ opts.sendDeleteWaiting }" class="loading"/>
                </button>
                <button class="btn btn-default comment-edit-button"
                        if="{ !opts.checkIsEditting() }"
                        onclick="{ opts.openEditArea }">
                    { t("Edit") }
                </button>
                <button class="btn btn-warning probably-hidden"
                        if="{ opts.checkIsEditting() }"
                        onclick="{ opts.closeEditArea }">
                    { t("Cancel") }
                </button>
            </div>

            <!-- Not Author buttons -->
            <div if="{ !opts.checkIsAuthor() }">
                <button class="btn btn-default comment-upvote-button"
                        data-vote="up"
                        onclick="{ opts.sendVote }">
                    +1
                    <span if="{ opts.sendVoteWaiting && opts.upvotting }"
                          class="loading"/>
                </button>
                <button class="btn btn-default comment-downvote-button"
                        data-vote="down"
                        onclick="{ opts.sendVote }">
                    -1
                    <span if="{ opts.sendVoteWaiting && !opts.upvotting }"
                          class="loading"/>
                </button>
                <button class="btn btn-danger comment-report-button"
                        if ="{ !hidden }"
                        title="{ t('Report comment as inappropriate') }"
                        onclick="{ opts.sendReport }">
                    { t('Report') }
                    <span if="{ opts.sendReportWaiting }" class="loading"/>
                </button>
            </div>

            <span>Gostaram: {upvotes}</span>
            <span>NÃ£o gostaram: {downvotes}</span>
            <span>Criado: {created}</span>
            <span>Modificado: {modified}</span>

            <!-- Reply form -->
            <form class="form"
                  if="{ opts.checkIsReplying() }">
                <div class="form-group">
                    <label class="sr-only"
                           for="comment-reply-textarea-{opts.id}">
                        { t('Reply Comment') }
                    </label>
                    <textarea id="comment-reply-textarea-{opts.id}"
                              class="form-control"
                              maxlength="500"
                              rows="3"/>
                </div>
                <button type="submit"
                        onclick="{ opts.sendReply }"
                        class="btn btn-default">
                    { t("Send") }
                    <span if="{ opts.sendReplyWaiting }" class="loading"/>
                </button>
                <button class="btn btn-warning"
                        onclick="{ opts.closeReplyArea }">
                    { t("Cancel") }
                </button>
            </form>
        </div>

        <!-- Replies list -->
        <comment each="{ replies }"
                 style="margin: 40px;"/>
    </div>


    <script type="es6">
    import {checkIsLogged} from '../../store/auth'
    import auth from '../../store/auth'
    this.checkIsLogged = checkIsLogged
    this.mixin('base')
    this.watch('username')

    // RiotJS makes tags inherit parent. This tag uses recursion, so "this"
    // variables were inheriting from parent giving a BIG mess. To avoid this
    // we place local variables at "this.opts"
    opts.isReplying = false
    opts.isEditting = false
    opts.id = this.id
    opts.author = this.author
    opts.url = this.url
    opts['report_url'] = this['report_url']
    opts['vote_url'] = this['vote_url']
    opts.update = this.update

    opts.openEditArea = function() {opts.isEditting = true}
    opts.openReplyArea = function(event) {
        if (this.checkIsLogged(event)) opts.isReplying = true
    }
    opts.closeEditArea = function() {
        opts.isEditting = false
        document.getElementById(`comment-edit-textarea-${opts.id}`).value = ''
        opts.update()
    }
    opts.closeReplyArea = function() {
        opts.isReplying = false
        document.getElementById(`comment-reply-textarea-${opts.id}`).value = ''
        opts.update()
    }
    opts.checkIsReplying = function() {return opts.isReplying}
    opts.checkIsEditting = function() {return opts.isEditting}
    opts.checkIsAuthor = function() {
        return opts.author == auth.getUsername()}

    opts.sendReply = function() {
        this.safeTriggerChange('sendReply', {
            text: document.getElementById(
                `comment-reply-textarea-${opts.id}`).value,
            url: opts.url,
        }, opts, false, opts.closeReplyArea)
    }

    opts.sendEdit = function() {
        this.safeTriggerChange('sendEdit', {
            text: document.getElementById(
                `comment-edit-textarea-${opts.id}`).value,
            url: opts.url,
        }, opts, false, opts.closeEditArea)
    }

    opts.sendDelete = function() {
        this.safeTriggerChange('sendDelete', {url: opts.url,}, opts)
    }

    opts.sendReport = function() {
        this.safeTriggerChange('sendReport', {url: opts['report_url']}, opts)
    }

    opts.sendVote = function(event) {
        if (this.checkIsLogged(event)) {
            let type = event.target.dataset.vote == 'up' ? true : false
            opts.upvotting = type
            this.safeTriggerChange('sendVote', {
                url: opts['vote_url'],
                vote: type,
            }, opts)
        }
    }
    </script>
</comment>
